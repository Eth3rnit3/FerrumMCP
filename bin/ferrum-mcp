#!/usr/bin/env ruby
# frozen_string_literal: true

require 'optparse'
require 'fileutils'

# Parse command line arguments
options = {
  transport: 'http',
  host: ENV.fetch('MCP_SERVER_HOST', '0.0.0.0'),
  port: ENV.fetch('MCP_SERVER_PORT', '3000').to_i,
  log_level: ENV.fetch('LOG_LEVEL', 'info')
}

command = ARGV[0]

if command == 'start' || command.nil?
  ARGV.shift if command == 'start'

  OptionParser.new do |opts|
    opts.banner = "Usage: ferrum-mcp start [options]"
    opts.separator ""
    opts.separator "Options:"

    opts.on('-t', '--transport TYPE', [:http, :stdio],
            'Transport type (http or stdio)',
            "  Default: #{options[:transport]}") do |t|
      options[:transport] = t.to_s
    end

    opts.on('-H', '--host HOST',
            'Server host (HTTP only)',
            "  Default: #{options[:host]}") do |h|
      options[:host] = h
    end

    opts.on('-p', '--port PORT', Integer,
            'Server port (HTTP only)',
            "  Default: #{options[:port]}") do |p|
      options[:port] = p
    end

    opts.on('-l', '--log-level LEVEL', [:debug, :info, :warn, :error],
            'Log level (debug, info, warn, error)',
            "  Default: #{options[:log_level]}") do |l|
      options[:log_level] = l.to_s
    end

    opts.on('-h', '--help', 'Show this help message') do
      puts opts
      exit
    end

    opts.on('-v', '--version', 'Show version') do
      require_relative '../lib/ferrum_mcp/version'
      puts "FerrumMCP #{FerrumMCP::VERSION}"
      exit
    end
  end.parse!

  # Set environment variables from options
  ENV['MCP_SERVER_HOST'] = options[:host]
  ENV['MCP_SERVER_PORT'] = options[:port].to_s
  ENV['LOG_LEVEL'] = options[:log_level]

  # Require and start server
  require_relative '../server'

  # server.rb handles the actual startup based on --transport flag
  # which is still in ARGV

elsif command == 'version' || command == '-v' || command == '--version'
  require_relative '../lib/ferrum_mcp/version'
  puts "FerrumMCP #{FerrumMCP::VERSION}"

elsif command == 'help' || command == '-h' || command == '--help'
  puts <<~HELP
    FerrumMCP - Browser Automation Server for Model Context Protocol

    USAGE:
        ferrum-mcp [COMMAND] [OPTIONS]

    COMMANDS:
        start       Start the FerrumMCP server (default)
        version     Show version information
        help        Show this help message

    OPTIONS:
        -t, --transport TYPE        Transport type: http or stdio (default: http)
        -H, --host HOST             Server host (default: 0.0.0.0)
        -p, --port PORT             Server port (default: 3000)
        -l, --log-level LEVEL       Log level: debug, info, warn, error (default: info)
        -h, --help                  Show this help message
        -v, --version               Show version

    EXAMPLES:
        # Start HTTP server on default port
        ferrum-mcp start

        # Start HTTP server on custom port
        ferrum-mcp start --port 8080

        # Start STDIO server (for Claude Desktop)
        ferrum-mcp start --transport stdio

        # Start with debug logging
        ferrum-mcp start --log-level debug

    ENVIRONMENT VARIABLES:
        MCP_SERVER_HOST             Server host (default: 0.0.0.0)
        MCP_SERVER_PORT             Server port (default: 3000)
        BROWSER_HEADLESS            Run browser in headless mode (default: true)
        BROWSER_TIMEOUT             Browser timeout in seconds (default: 60)
        LOG_LEVEL                   Log level (default: info)

        See .env.example for all configuration options.

    DOCUMENTATION:
        Getting Started: https://github.com/Eth3rnit3/FerrumMCP/blob/main/docs/GETTING_STARTED.md
        API Reference:   https://github.com/Eth3rnit3/FerrumMCP/blob/main/docs/API_REFERENCE.md
        Configuration:   https://github.com/Eth3rnit3/FerrumMCP/blob/main/docs/CONFIGURATION.md

    For more information, visit: https://github.com/Eth3rnit3/FerrumMCP
  HELP

else
  warn "Unknown command: #{command}"
  warn "Run 'ferrum-mcp help' for usage information"
  exit 1
end
