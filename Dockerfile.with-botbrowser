# Dockerfile with BotBrowser support (Debian-based for glibc compatibility)
#
# This Dockerfile uses Debian instead of Alpine for full BotBrowser compatibility.
# BotBrowser binaries are compiled for glibc and require many glibc-specific symbols.
#
# Build example:
#   docker build -f Dockerfile.with-botbrowser -t ferrum-mcp:botbrowser .

# Use Ruby 3.2 with Debian Slim for glibc compatibility
FROM ruby:3.2-slim

# Build arguments
ARG TARGETARCH
ARG BOTBROWSER_REPO=botswin/BotBrowser

# Install runtime dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    # Build dependencies (will be removed later)
    build-essential \
    pkg-config \
    libvips-dev \
    # Common dependencies
    ca-certificates \
    wget \
    curl \
    xvfb \
    # Runtime: libvips for ruby-vips gem (keep runtime library)
    libvips42 \
    # Runtime: Python and ffmpeg for whisper-cli (CAPTCHA solving)
    python3 \
    python3-pip \
    ffmpeg \
    # Browser dependencies for BotBrowser
    libnss3 \
    libatk1.0-0 \
    libatk-bridge2.0-0 \
    libcups2 \
    libdrm2 \
    libxkbcommon0 \
    libxcomposite1 \
    libxdamage1 \
    libxrandr2 \
    libgbm1 \
    libxfixes3 \
    libxext6 \
    libx11-6 \
    libasound2 \
    libatspi2.0-0 \
    libnspr4 \
    && rm -rf /var/lib/apt/lists/*

# Create non-root user
RUN groupadd -g 1000 ferrum && \
    useradd -u 1000 -g ferrum -m ferrum

#
# BotBrowser installation
#
RUN if [ "$TARGETARCH" = "amd64" ]; then \
        DOWNLOAD_URL="https://github.com/botswin/BotBrowser/releases/download/v142-20251117/botbrowser_20251119_142.0.7444.163_x86_64.deb"; \
    elif [ "$TARGETARCH" = "arm64" ]; then \
        DOWNLOAD_URL="https://github.com/botswin/BotBrowser/releases/download/v142-20251117/botbrowser_20251119_142.0.7444.163_arm64.deb"; \
    else \
        echo "Unsupported architecture: $TARGETARCH" && exit 1; \
    fi && \
    echo "Downloading BotBrowser from: $DOWNLOAD_URL" && \
    wget -O /tmp/botbrowser.deb "$DOWNLOAD_URL" && \
    # Install missing dependencies first
    echo "Installing BotBrowser dependencies..." && \
    apt-get update && \
    apt-get install -y --no-install-recommends fonts-liberation libgtk-3-0 xdg-utils && \
    # Install the .deb package
    echo "Installing BotBrowser package..." && \
    dpkg -i /tmp/botbrowser.deb && \
    # Find BotBrowser installation
    BOTBROWSER_PATH=$(find /opt -type f \( -name "chrome" -o -name "botbrowser" \) 2>/dev/null | head -1) && \
    if [ -n "$BOTBROWSER_PATH" ]; then \
        BOTBROWSER_DIR=$(dirname "$BOTBROWSER_PATH") && \
        echo "Found BotBrowser in: $BOTBROWSER_DIR" && \
        # Ensure it's executable
        chmod +x "$BOTBROWSER_DIR"/chrome 2>/dev/null || true && \
        chmod +x "$BOTBROWSER_DIR"/chrome-sandbox 2>/dev/null || true && \
        chmod +x "$BOTBROWSER_DIR"/chrome_crashpad_handler 2>/dev/null || true && \
        chown -R ferrum:ferrum "$BOTBROWSER_DIR" && \
        ln -sf "$BOTBROWSER_DIR" /opt/botbrowser; \
    else \
        echo "Error: Could not find BotBrowser executable" && \
        exit 1; \
    fi && \
    # Cleanup
    rm -rf /tmp/botbrowser.deb && \
    rm -rf /var/lib/apt/lists/* && \
    echo "BotBrowser installation complete"

# Set environment variables
ENV BROWSER_HEADLESS=true \
    DOCKER=true \
    PORT=3000 \
    HOST=0.0.0.0 \
    LOG_LEVEL=info \
    BROWSER_TIMEOUT=120 \
    BOTBROWSER_PATH=/opt/botbrowser/chrome

# Create app directory
WORKDIR /app

# Copy Gemfile and install dependencies
COPY Gemfile Gemfile.lock ./
RUN bundle config set --local without 'development test' && \
    bundle install --jobs=4 --retry=3 && \
    # Install openai-whisper for CAPTCHA solving
    pip3 install --no-cache-dir --break-system-packages openai-whisper && \
    # Remove build dependencies to reduce image size
    apt-get purge -y build-essential pkg-config libvips-dev && \
    apt-get autoremove -y && \
    rm -rf /var/lib/apt/lists/* && \
    # Clean bundle cache
    rm -rf /usr/local/bundle/cache/*.gem && \
    find /usr/local/bundle/gems/ -name "*.c" -delete && \
    find /usr/local/bundle/gems/ -name "*.o" -delete

# Copy application code (only what's needed)
COPY --chown=ferrum:ferrum lib ./lib
COPY --chown=ferrum:ferrum bin ./bin

# Create directories for logs, temp files, and profiles
# Profiles should be mounted as volumes at runtime
RUN mkdir -p logs tmp profiles && \
    chown -R ferrum:ferrum /app

# Switch to non-root user
USER ferrum

# Expose the server port
EXPOSE 3000

# Health check
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD curl -f http://localhost:3000/health || exit 1

# Security options for Chrome/BotBrowser
# Run with: docker run --security-opt seccomp=unconfined

# Run the server
CMD ["bin/ferrum-mcp", "start"]
